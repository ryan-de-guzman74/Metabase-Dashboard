services:
  # üß± MySQL Database (local warehouse)
  mysql:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_ROOT_HOST: "%"
    ports:
      - "3306:3306"
    volumes:
      - ./mysql_data:/var/lib/mysql
      - ./mysql_conf/my.cnf:/etc/mysql/conf.d/my.cnf
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 10s
      retries: 10
    networks:
      - metanet

  # üìä Metabase Dashboard (connected to MySQL)
  metabase:
    image: metabase/metabase
    restart: always
    ports:
      - "3000:3000"
    environment:
      MB_DB_TYPE: mysql
      MB_DB_DBNAME: metabase_app
      MB_DB_PORT: 3306
      MB_DB_USER: root
      MB_DB_PASS: rootpass
      MB_DB_HOST: mysql
      MB_DB_CONNECTION_TIMEOUT: 300
      MB_DB_CONNECTION_MAX_LIFETIME: 7200
      MB_DB_SYNC_INTERVAL: 3600
      MB_DB_FIELD_SCAN_INTERVAL: 86400
      MB_EMBEDDING_APP_ORIGIN: "*"
    volumes:
      - ./metabase_data:/metabase-data
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - metanet

  # ‚öôÔ∏è ETL Automation (runs schema + pulls live data every 2 hours)
  etl:
    image: ubuntu:22.04
    restart: always
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    working_dir: /app
    environment: 
      - ENVIRONMENT=docker
    volumes:
      - ./sql_scripts:/app/sql_scripts:rw
      - ./etl.sh:/app/etl.sh:rw
      - ./lib:/app/lib:rw
      - ./etl_config.env:/app/etl_config.env:rw
      - ./logs:/app/logs
    entrypoint: >
      /bin/bash -c "
        export ENVIRONMENT=docker &&
        apt update -qq &&
        apt install -y -qq mysql-client curl jq &&
        chmod +x /app/etl.sh &&
        mkdir -p /app/logs &&
        echo '‚è≥ Waiting for MySQL to be ready...' &&
        until mysql -h mysql -u root -prootpass -e 'SELECT 1;' >/dev/null 2>&1; do sleep 5; done &&
        echo '‚úÖ MySQL ready. Checking schema...' &&
        mysql -h mysql -u root -prootpass < /app/sql_scripts/setup_ecommerce_databases.sql &&
        echo '‚úÖ Schema ready. Starting ETL loop...' &&
        while true; do
          LOG_FILE=/app/logs/etl_$(date +%Y-%m-%d_%H-%M).log;
          echo '‚è∞ Starting ETL at' $(date) | tee -a $$LOG_FILE;
          start_time=$$(date +%s);
          /app/etl.sh 2>&1 | tee -a $$LOG_FILE;
          exit_code=$$?;
          end_time=$$(date +%s);
          duration=$$((end_time - start_time));
          if [ $$exit_code -eq 0 ]; then
            echo '‚úÖ ETL completed successfully in '$$duration's.' | tee -a $$LOG_FILE;
          else
            echo '‚ùå ETL failed (exit code '$$exit_code') after '$$duration's.' | tee -a $$LOG_FILE;
          fi;
          find /app/logs -type f -mtime +7 -delete;
          echo 'üí§ Sleeping 120 minutes...' | tee -a $$LOG_FILE;
          sleep 7200;
        done
      "
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - metanet

networks:
  metanet:
    driver: bridge

